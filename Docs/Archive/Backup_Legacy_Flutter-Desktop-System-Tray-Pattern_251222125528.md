# ðŸ”” Flutter Desktop System Tray Pattern

> System tray integration and native notifications

---

## Overview

System tray icon and menu implementation with native notifications using system_tray and local_notifier packages.

---

## Dependencies

```yaml
dependencies:
  system_tray: ^2.0.3
  local_notifier: ^0.1.6
  # For launch at startup
  launch_at_startup: ^0.2.2
```

---

## Implementation

### 1. System Tray Manager

```dart
// core/tray/system_tray_manager.dart
import 'package:system_tray/system_tray.dart';
import 'package:local_notifier/local_notifier.dart';

class SystemTrayManager {
  static final SystemTrayManager _instance = SystemTrayManager._internal();
  factory SystemTrayManager() => _instance;
  SystemTrayManager._internal();

  final SystemTray _systemTray = SystemTray();
  bool _isInitialized = false;

  Future<void> initialize() async {
    if (_isInitialized) return;

    // Initialize system tray
    await _systemTray.initSystemTray(
      title: 'My App',
      iconPath: _getIconPath(),
      toolTip: 'My App is running',
    );

    // Setup menu
    final menu = Menu();
    await menu.buildFrom([
      MenuItemLabel(
        label: 'Show Window',
        onClicked: (menuItem) => _showWindow(),
      ),
      MenuSeparator(),
      MenuItemLabel(
        label: 'Settings',
        onClicked: (menuItem) => _openSettings(),
      ),
      MenuSeparator(),
      MenuItemLabel(
        label: 'Quit',
        onClicked: (menuItem) => _quit(),
      ),
    ]);

    await _systemTray.setContextMenu(menu);

    // Handle tray icon click
    _systemTray.registerSystemTrayEventHandler((eventName) {
      if (eventName == kSystemTrayEventClick) {
        _showWindow();
      } else if (eventName == kSystemTrayEventRightClick) {
        _systemTray.popUpContextMenu();
      }
    });

    // Initialize local notifier
    await localNotifier.setup(
      appName: 'My App',
      shortcutPolicy: ShortcutPolicy.requireCreate,
    );

    _isInitialized = true;
  }

  String _getIconPath() {
    if (Platform.isWindows) {
      return 'assets/icon/app_icon.ico';
    } else if (Platform.isMacOS) {
      return 'assets/icon/app_icon.png';
    } else {
      return 'assets/icon/app_icon.png';
    }
  }

  void _showWindow() {
    windowManager.show();
    windowManager.focus();
  }

  void _openSettings() {
    // Navigate to settings
  }

  void _quit() {
    windowManager.destroy();
  }

  Future<void> showNotification({
    required String title,
    required String body,
    List<LocalNotificationAction>? actions,
  }) async {
    final notification = LocalNotification(
      title: title,
      body: body,
      actions: actions,
    );

    notification.onShow = () {
      print('Notification shown');
    };

    notification.onClick = () {
      _showWindow();
    };

    notification.onClickAction = (actionIndex) {
      // Handle action click
    };

    await notification.show();
  }

  Future<void> updateTrayIcon(String iconPath) async {
    await _systemTray.setImage(iconPath);
  }

  Future<void> setToolTip(String tooltip) async {
    await _systemTray.setToolTip(tooltip);
  }

  void dispose() {
    _systemTray.destroy();
  }
}
```

### 2. Launch at Startup

```dart
// core/startup/launch_at_startup_manager.dart
import 'package:launch_at_startup/launch_at_startup.dart';
import 'package:package_info_plus/package_info_plus.dart';

class LaunchAtStartupManager {
  static Future<void> initialize() async {
    final packageInfo = await PackageInfo.fromPlatform();

    launchAtStartup.setup(
      appName: packageInfo.appName,
      appPath: Platform.resolvedExecutable,
    );
  }

  static Future<bool> isEnabled() async {
    return await launchAtStartup.isEnabled();
  }

  static Future<void> enable() async {
    await launchAtStartup.enable();
  }

  static Future<void> disable() async {
    await launchAtStartup.disable();
  }
}
```

---

## Best Practices

1. **Icon Formats**: Use proper icon formats for each platform
2. **Minimize to Tray**: Optionally minimize to tray instead of closing
3. **Badge/Counter**: Show notification count on tray icon
4. **Context Menu**: Provide quick actions in tray menu
5. **Notification Grouping**: Group related notifications

---

*Generated by Archon*